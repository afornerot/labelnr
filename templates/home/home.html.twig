{% extends 'base.html.twig' %}

{% block localstyle %}
<style>
    verysmall { zoom:70%; }

    big { zoom: 130%; }

    surline {
        background-color: #fff;
        color: #000;
        padding:5px;
        display: block;
        font-weight: bold;
        zoom: 130%;
    }

    #table-container { transition: opacity 0.3s ease; }

    surline.btn-collapse:hover {
        background-color: #f8f9fa !important;
        filter: brightness(95%);
    }

    surline.btn-collapse::after {
        content: '▼';
        font-size: 0.8em;
        margin-left: 10px;
        transition: transform 0.3s;
    }

    surline.btn-collapse[aria-expanded="true"]::after {
        transform: rotate(180deg);
    }

    .textarea-comment {

        min-height: calc(3em + 0.75rem + 2px);
    }
</style>
{% endblock %}

{% block body %}
    {# On inclut le fragment pour le premier affichage au chargement de la page #}
    {% include 'home/table.html.twig' %}
{% endblock %}

{% block localscript %}
<script>
    function autosize(textarea) {
        textarea.style.height = 'auto';
        console.log(textarea.scrollHeight);
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    function initializeAutosize() {
        $('.textarea-comment').each(function() {
            autosize(this);
        });
    }

    $(document).ready(function() {
        initializeAutosize();

        $(document).on('input', '.textarea-comment', function() {
            autosize(this);
        });

        $(document).on('change', '.select-maturity', function() {
            const $select = $(this);

            const openIds = [];
            $('.collapse.show').each(function() {
                openIds.push($(this).attr('id'));
            });
            
            const data = {
                tirId: $select.data('tir-id'),
                maturityId: $select.val()
            };

            $('#table-container').css('opacity', 0.5);

            $.ajax({
                url: "{{ path('app_tir_updatematurity') }}", // Vérifiez bien le nom de la route
                method: 'POST',
                data: data,
                success: function(response) {
                    $('#table-container').replaceWith(response);

                    openIds.forEach(function(id) {
                        const $target = $('#' + id);
                        if ($target.length) {
                            $target.addClass('show');
                            $(`[data-target="#${id}"], [data-bs-target="#${id}"]`).attr('aria-expanded', 'true');
                        }
                    });
                    initializeAutosize();
                },
                error: function() {
                    alert("Erreur lors de la mise à jour des données.");
                    $('#table-container').css('opacity', 1);
                }
            });
        });

        $(document).on('change', '.textarea-comment', function() {
            const $textarea = $(this);

            const openIds = [];
            $('.collapse.show').each(function() {
                openIds.push($(this).attr('id'));
            });
            
            const data = {
                tirId: $textarea.data('tir-id'),
                comment: $textarea.val()
            };

            $('#table-container').css('opacity', 0.5);

            $.ajax({
                url: "{{ path('app_tir_updatecomment') }}",
                method: 'POST',
                data: data,
                success: function(response) {
                    $('#table-container').replaceWith(response);

                    openIds.forEach(function(id) {
                        const $target = $('#' + id);
                        if ($target.length) {
                            $target.addClass('show');
                            $(`[data-target="#${id}"], [data-bs-target="#${id}"]`).attr('aria-expanded', 'true');
                        }
                    });
                    initializeAutosize();
                },
                error: function() {
                    alert("Erreur lors de la mise à jour du commentaire.");
                    $('#table-container').css('opacity', 1);
                }
            });
        });

        $(document).on('click', '.btn-collapse', function() {
            const target = $(this).data('target');
            $(target).collapse('toggle');
        });
    });
</script>
{% endblock %}